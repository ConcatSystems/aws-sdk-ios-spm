# .circleci/config.yml

version: 2.1

defaults: &defaults
  macos:
    xcode: '12.0.0'
  working_directory: ~/aws-sdk-ios-spm

references:
  repo_cache_key: &repo_cache_key v2-repo-{{ .Branch }}-{{ .Revision }}

  restore_repo: &restore_repo
    restore_cache:
      keys:
        - *repo_cache_key
        - v2-repo-{{ .Branch }}
        - v2-repo

commands:
  make_artifacts_directory:
    steps:
      - run:
          name: Make artifacts directory
          command: mkdir -p "artifacts"
  
  upload_artifacts:
    steps:
      - store_artifacts:
          path: artifacts

jobs:
  checkout_code:
    <<: *defaults
    steps:
      - *restore_repo
      - checkout
      - save_cache:
          key: *repo_cache_key
          paths:
            - ~/aws-sdk-ios-spm
  release:
    <<: *defaults
    steps:
      - run:
          name: Extract version
          command: |
            cat Package.swift | grep -o -E '[0-9]'
            ls
            package_version = 1.2.2
      - run:
          name: Merge release to main
          command: |
            git rebase main
            
workflows:

  release_sdk:
    jobs:
      - checkout_code:
          filters:
            branches:
              only: 
                - royjit.circleci
      - release:
          requires:
              - checkout_code
          filters:
            branches:
              only: 
                - royjit.circleci
          

